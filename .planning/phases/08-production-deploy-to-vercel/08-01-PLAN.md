---
phase: 08-production-deploy-to-vercel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - package.json
  - prisma/schema.prisma
  - app/db.server.ts
  - .env.example
  - .gitignore
  - shopify.app.production.toml
autonomous: true

must_haves:
  truths:
    - "Vite config includes vercelPreset() so Remix routes deploy as serverless functions"
    - "Build command runs prisma generate, prisma migrate deploy, then shopify app build"
    - "Prisma schema supports dual connection strings (pooled for runtime, direct for migrations)"
    - "Node.js engine requirement is >=20 to avoid Vercel deprecation errors"
    - "Production Shopify app config exists as a separate TOML file preserving dev setup"
    - "Local dev workflow (ngrok) is unaffected by production config changes"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vercel preset integration for serverless deployment"
      contains: "vercelPreset"
    - path: "package.json"
      provides: "Vercel build script and Node 20 engine"
      contains: "vercel-build"
    - path: "prisma/schema.prisma"
      provides: "Dual connection URL support for Neon"
      contains: "directUrl"
    - path: "shopify.app.production.toml"
      provides: "Production Shopify app configuration template"
      contains: "application_url"
    - path: ".env.example"
      provides: "Updated environment variable template with DIRECT_URL"
      contains: "DIRECT_URL"
  key_links:
    - from: "vite.config.ts"
      to: "@vercel/remix/vite"
      via: "import vercelPreset"
      pattern: "vercelPreset"
    - from: "prisma/schema.prisma"
      to: "env(\"DIRECT_URL\")"
      via: "directUrl field in datasource"
      pattern: "directUrl.*env.*DIRECT_URL"
    - from: "package.json"
      to: "prisma generate && prisma migrate deploy"
      via: "vercel-build script"
      pattern: "vercel-build"
---

<objective>
Configure the codebase for Vercel deployment with Neon PostgreSQL support.

Purpose: Prepare all configuration files so the app can be deployed to Vercel as serverless functions with a Neon production database, while keeping the existing local dev setup (ngrok + Docker PostgreSQL) fully functional.

Output: Updated vite.config.ts, package.json, prisma/schema.prisma, db.server.ts, .env.example, .gitignore, and a new shopify.app.production.toml template.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-production-deploy-to-vercel/08-RESEARCH.md

@vite.config.ts
@package.json
@prisma/schema.prisma
@app/db.server.ts
@.env.example
@.gitignore
@shopify.app.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @vercel/remix and configure Vite + build pipeline</name>
  <files>vite.config.ts, package.json</files>
  <action>
1. Install `@vercel/remix` package:
   ```bash
   npm install @vercel/remix
   ```

2. Update `vite.config.ts`:
   - Add import: `import { vercelPreset } from "@vercel/remix/vite";`
   - Add `presets: [vercelPreset()]` to the `remix()` plugin options
   - Keep ALL existing config (port, allowedHosts, HMR, define block) unchanged — local dev must still work
   - The vercelPreset is a no-op during `vite dev` and only activates during `vite build`, so it doesn't break dev

3. Update `package.json`:
   - Add script: `"vercel-build": "prisma generate && prisma migrate deploy && npm run build"`
   - This runs Prisma codegen + migrations before `shopify app build` (which calls `remix vite:build`)
   - Update `engines.node` from `">=18.0.0"` to `">=20.0.0"` (Node 18 deprecated on Vercel since Sep 2025)
   - Do NOT change any other scripts — `dev`, `build`, `start` must remain for local workflow
  </action>
  <verify>
   - `npm ls @vercel/remix` shows the package installed
   - `grep "vercelPreset" vite.config.ts` finds the preset
   - `node -e "const p = require('./package.json'); console.log(p.scripts['vercel-build'])"` outputs the build command
   - `node -e "const p = require('./package.json'); console.log(p.engines.node)"` outputs `>=20.0.0`
  </verify>
  <done>
   vite.config.ts includes vercelPreset() in remix plugin presets array. package.json has vercel-build script running prisma generate + migrate deploy + build. Node engine is >=20.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Prisma dual-URL, db.server.ts, env template, gitignore, and production TOML</name>
  <files>prisma/schema.prisma, app/db.server.ts, .env.example, .gitignore, shopify.app.production.toml</files>
  <action>
1. Update `prisma/schema.prisma`:
   - Add `directUrl = env("DIRECT_URL")` to the `datasource db` block
   - This tells Prisma CLI to use the direct (non-pooled) Neon connection for migrations
   - Keep `url = env("DATABASE_URL")` unchanged for runtime use
   - No other schema changes

2. Update `app/db.server.ts`:
   - No changes needed. The existing pg Pool + PrismaPg adapter pattern works with Neon's pooled connection.
     The Pool reads DATABASE_URL which will be the Neon pooled URL in production.
   - Add a comment noting that DIRECT_URL is used by Prisma CLI only (not runtime)

3. Update `.env.example` to document all required production environment variables:
   ```
   # Shopify OAuth (from Partner Dashboard)
   SHOPIFY_API_KEY=your_api_key_here
   SHOPIFY_API_SECRET=your_api_secret_here

   # App configuration
   SCOPES=write_draft_orders,read_products,write_products
   SHOPIFY_APP_URL=https://your-app.vercel.app

   # Database - Local development (Docker PostgreSQL)
   DATABASE_URL=postgresql://postgres:postgres@localhost:5400/shopify_price_app

   # Database - Production (Neon PostgreSQL)
   # DATABASE_URL=postgresql://user:pass@ep-xxx-pooler.us-east-2.aws.neon.tech/dbname?sslmode=require&connect_timeout=15
   # DIRECT_URL=postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/dbname?sslmode=require

   # Local dev tunnel
   TUNNEL_DOMAIN=fagaceous-rana-carbolated.ngrok-free.dev
   ```

4. Update `.gitignore`:
   - Add `.vercel` directory (Vercel CLI creates this for project linking)

5. Create `shopify.app.production.toml`:
   - Template for production Shopify app configuration
   - Placeholder `client_id` and `application_url` — user fills in after creating production app in Partner Dashboard
   - Same scopes and webhook config as development TOML
   - Include comment explaining this is for production deployment
   ```toml
   # Production Shopify app configuration
   # Usage: shopify app deploy --config shopify.app.production.toml
   #
   # Before using:
   # 1. Create a new app in Shopify Partner Dashboard
   # 2. Replace client_id with the production app's Client ID
   # 3. Replace YOUR_APP with your actual Vercel subdomain

   client_id = "REPLACE_WITH_PRODUCTION_CLIENT_ID"
   name = "Dynamic Pricing"
   application_url = "https://YOUR_APP.vercel.app"
   embedded = true

   [build]
   dev_store_url = "pricing-app-3.myshopify.com"

   [webhooks]
   api_version = "2026-01"

     [[webhooks.subscriptions]]
     topics = [ "app/uninstalled" ]
     uri = "/webhooks"

   [access_scopes]
   scopes = "write_draft_orders,read_products,write_products"
   optional_scopes = [ ]
   use_legacy_install_flow = false

   [auth]
   redirect_urls = [
     "https://YOUR_APP.vercel.app/auth/callback"
   ]

   [pos]
   embedded = false
   ```
  </action>
  <verify>
   - `grep "directUrl" prisma/schema.prisma` finds the direct URL config
   - `grep "DIRECT_URL" .env.example` finds the production database template
   - `grep ".vercel" .gitignore` finds the Vercel directory exclusion
   - `test -f shopify.app.production.toml && echo "exists"` confirms production TOML created
   - `grep "REPLACE_WITH_PRODUCTION_CLIENT_ID" shopify.app.production.toml` confirms placeholder is present
   - `npx shopify app dev` still works (local dev unaffected) — can be verified manually if needed
  </verify>
  <done>
   Prisma schema has directUrl for Neon migrations. .env.example documents all production variables including DIRECT_URL. .gitignore excludes .vercel directory. shopify.app.production.toml exists as a template for production deployment with placeholder values.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @vercel/remix` — package installed
2. `grep -c "vercelPreset" vite.config.ts` — returns 1+
3. `grep "vercel-build" package.json` — build script exists
4. `grep "directUrl" prisma/schema.prisma` — dual URL configured
5. `test -f shopify.app.production.toml` — production TOML exists
6. `grep ".vercel" .gitignore` — Vercel output excluded
7. `npx prisma validate` — schema is valid
</verification>

<success_criteria>
- @vercel/remix is installed and vite.config.ts includes vercelPreset()
- package.json has vercel-build script and Node >=20 engine
- Prisma schema supports directUrl for Neon migrations
- Production Shopify app TOML template exists with placeholder values
- .env.example documents all required production environment variables
- Local dev workflow is completely unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-deploy-to-vercel/08-01-SUMMARY.md`
</output>
