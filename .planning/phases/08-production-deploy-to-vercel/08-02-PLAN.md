---
phase: 08-production-deploy-to-vercel
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - shopify.app.production.toml
autonomous: false
user_setup:
  - service: neon
    why: "Production PostgreSQL database"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Dashboard → Project → Connection Details → Pooled connection string (with -pooler in hostname). Append ?sslmode=require&connect_timeout=15"
      - name: DIRECT_URL
        source: "Neon Dashboard → Project → Connection Details → Direct connection string (without -pooler). Append ?sslmode=require"
    dashboard_config:
      - task: "Create Neon project"
        location: "https://neon.tech → Sign up/Log in → New Project → Name: pricing-app-production, Region: US East 2"
  - service: shopify-partner-dashboard
    why: "Production Shopify app with separate API credentials"
    env_vars:
      - name: SHOPIFY_API_KEY
        source: "Partner Dashboard → Apps → [Production App] → Client credentials → Client ID"
      - name: SHOPIFY_API_SECRET
        source: "Partner Dashboard → Apps → [Production App] → Client credentials → Client secret (reveal once, save securely)"
    dashboard_config:
      - task: "Create production Shopify app"
        location: "https://partners.shopify.com → Apps → Create app → Create app manually"
  - service: vercel
    why: "Hosting platform for production deployment"
    env_vars:
      - name: SHOPIFY_APP_URL
        source: "Vercel Dashboard → Project → Settings → Domains → copy production URL (https://xxx.vercel.app)"
    dashboard_config:
      - task: "Import GitHub repository"
        location: "https://vercel.com/new → Import Git Repository → Select pricing-app repo"
      - task: "Set environment variables"
        location: "Vercel Dashboard → Project → Settings → Environment Variables"

must_haves:
  truths:
    - "App is deployed and accessible at a stable Vercel URL"
    - "Production database is provisioned on Neon and migrations have been applied"
    - "Vercel environment variables are configured with production values"
    - "Production Shopify app exists in Partner Dashboard with Vercel URL"
    - "shopify.app.production.toml is updated with real production client_id and URL"
    - "Local dev workflow (ngrok + Docker) still works independently"
  artifacts:
    - path: "shopify.app.production.toml"
      provides: "Production Shopify app configuration with real values"
      contains: "vercel.app"
  key_links:
    - from: "Vercel deployment"
      to: "Neon database"
      via: "DATABASE_URL environment variable"
      pattern: "neon.tech"
    - from: "Vercel deployment"
      to: "Shopify Partner Dashboard"
      via: "SHOPIFY_API_KEY + SHOPIFY_APP_URL"
      pattern: "vercel.app"
---

<objective>
Deploy the app to Vercel with a production Neon database and Shopify app credentials.

Purpose: Get the app running in production at a stable URL so it can be registered in the Partner Dashboard (Phase 09) and verified end-to-end (Phase 10).

Output: Live Vercel deployment, provisioned Neon database with migrations applied, production Shopify app in Partner Dashboard, updated shopify.app.production.toml with real values.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-production-deploy-to-vercel/08-RESEARCH.md
@.planning/phases/08-production-deploy-to-vercel/08-01-SUMMARY.md

@shopify.app.production.toml
@shopify.app.toml
@app/shopify.server.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Neon database and production Shopify app</name>
  <what-built>Plan 08-01 configured the codebase for Vercel deployment with @vercel/remix, Prisma dual-URL support, and a production TOML template.</what-built>
  <action>
The user needs to create three external resources that Claude cannot automate:

**Step A: Create Neon PostgreSQL database**

1. Go to https://neon.tech and sign up or log in
2. Click "New Project"
   - **Project name:** `pricing-app-production`
   - **Region:** US East 2 (closest to Vercel's us-east-1)
   - **Compute size:** Free tier (0.25 CU)
3. After creation, go to **Connection Details** in the project dashboard
4. Copy TWO connection strings:
   - **Pooled connection** (hostname contains `-pooler`): This becomes `DATABASE_URL`
     - Append `?sslmode=require&connect_timeout=15` to the URL
   - **Direct connection** (hostname WITHOUT `-pooler`): This becomes `DIRECT_URL`
     - Append `?sslmode=require` to the URL
5. Save both URLs securely — you'll need them for Vercel env vars

**Step B: Create production Shopify app in Partner Dashboard**

1. Go to https://partners.shopify.com
2. Click **Apps** in left sidebar → **Create app** → **Create app manually**
3. **App name:** `Dynamic Pricing Production` (or your preference)
4. Click **Create app**
5. Copy the **Client ID** — save as `SHOPIFY_API_KEY`
6. Click **Reveal** next to Client secret — copy and save as `SHOPIFY_API_SECRET`
   - WARNING: You can only view the secret once. Store it in a password manager.
7. Navigate to **Configuration** tab
8. Leave the App URL and redirect URLs empty for now — we'll update them after Vercel deploys
9. In **Access scopes**, add: `write_draft_orders`, `read_products`, `write_products`
10. In **Embedded app** section, toggle **Embedded in Shopify admin** → ON
11. Click **Save**

**Step C: Deploy to Vercel**

1. Go to https://vercel.com/new
2. Click **Import Git Repository** → Select `pricing-app` repo from GitHub
3. **Framework Preset:** Should auto-detect as Remix
4. **Build Command:** `npm run vercel-build`
5. **Output Directory:** Leave default (auto-detected by @vercel/remix)
6. **Environment Variables** — Add these before clicking Deploy:
   - `DATABASE_URL` = pooled Neon URL from Step A (Production environment only)
   - `DIRECT_URL` = direct Neon URL from Step A (Production environment only)
   - `SHOPIFY_API_KEY` = Client ID from Step B (Production + Preview)
   - `SHOPIFY_API_SECRET` = Client secret from Step B (mark as Sensitive) (Production + Preview)
   - `SCOPES` = `write_draft_orders,read_products,write_products` (Production + Preview)
   - `SHOPIFY_APP_URL` = leave blank for now, update after first deploy gives you the URL
7. Click **Deploy**
8. Wait for build to complete — check build logs for:
   - `prisma generate` success
   - `prisma migrate deploy` success (creates tables in Neon)
   - `remix vite:build` success
9. Copy the deployment URL (e.g., `https://pricing-app-xxx.vercel.app`)

**Step D: Update Shopify app URLs and SHOPIFY_APP_URL**

1. In Vercel Dashboard → Project → Settings → Environment Variables:
   - Add `SHOPIFY_APP_URL` = `https://your-app.vercel.app` (the URL from step C9)
   - Trigger a redeploy (Deployments tab → ... → Redeploy)
2. In Shopify Partner Dashboard → Your production app → Configuration:
   - **App URL:** `https://your-app.vercel.app`
   - **Allowed redirection URL(s):** `https://your-app.vercel.app/auth/callback`
   - In **Webhooks** section, set API version to `2026-01` and add:
     - `app/uninstalled` → `https://your-app.vercel.app/webhooks`
     - `customers/data_request` → `https://your-app.vercel.app/webhooks`
     - `customers/redact` → `https://your-app.vercel.app/webhooks`
     - `shop/redact` → `https://your-app.vercel.app/webhooks`
   - Click **Save**
  </action>
  <resume-signal>
Provide the following values so Claude can update shopify.app.production.toml:
1. Vercel deployment URL (e.g., https://pricing-app-xxx.vercel.app)
2. Production Shopify app Client ID
3. Confirmation that Neon database was created and env vars are set in Vercel
4. Confirmation that Shopify app URLs are updated in Partner Dashboard

Example response: "Deployed to https://pricing-app-robin.vercel.app, client ID is abc123def456, Neon DB created, all env vars set, Partner Dashboard updated"
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update shopify.app.production.toml with real values and deploy config</name>
  <files>shopify.app.production.toml</files>
  <action>
Using the values provided by the user in the checkpoint resume signal:

1. Update `shopify.app.production.toml`:
   - Replace `REPLACE_WITH_PRODUCTION_CLIENT_ID` with the actual production Client ID
   - Replace `YOUR_APP` in `application_url` and `redirect_urls` with the actual Vercel subdomain
   - Remove the instruction comments at the top (keep it clean for production use)

2. Run `shopify app deploy --config shopify.app.production.toml` to push the production config to the Partner Dashboard
   - This syncs webhooks, scopes, and URLs from the TOML file to Shopify
   - If the CLI asks for confirmation, confirm

3. Verify the deployment is working:
   - `curl -s -o /dev/null -w "%{http_code}" https://VERCEL_URL/` — should return 200 or 302 (redirect to Shopify auth)
   - Check that the Vercel build logs show successful Prisma migration
  </action>
  <verify>
   - `shopify.app.production.toml` contains the real production client_id (no REPLACE placeholder)
   - `shopify.app.production.toml` contains the real Vercel URL (no YOUR_APP placeholder)
   - `curl -s -o /dev/null -w "%{http_code}" https://VERCEL_URL/` returns a non-5xx response
  </verify>
  <done>
   shopify.app.production.toml has real production values. Shopify config is deployed. Vercel deployment responds to HTTP requests without 5xx errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify production deployment</name>
  <what-built>App deployed to Vercel with Neon database, production Shopify app configured, shopify.app.production.toml updated with real values.</what-built>
  <how-to-verify>
1. **Check Vercel deployment:**
   - Visit `https://your-app.vercel.app` in browser
   - Should redirect to Shopify OAuth (expected behavior for unauthenticated access)

2. **Check database:**
   - Visit Neon Dashboard → your project → Tables
   - Should see tables: stores, gdpr_requests, price_matrices, breakpoints, matrix_cells, product_matrices, draft_order_records
   - Plus the Shopify session table

3. **Check local dev still works:**
   - Run `npx shopify app dev --tunnel-url https://fagaceous-rana-carbolated.ngrok-free.dev:9292`
   - App should still work locally with Docker PostgreSQL

4. **Check Vercel build logs:**
   - In Vercel Dashboard → Deployments → latest → Build Logs
   - Should show successful prisma generate, migrate deploy, and remix build
  </how-to-verify>
  <resume-signal>Type "approved" if deployment is working, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. Vercel deployment URL is accessible (non-5xx HTTP response)
2. Neon database has all required tables from Prisma migrations
3. shopify.app.production.toml contains real production values
4. Vercel build logs show successful prisma + remix build
5. Local dev workflow works independently (ngrok + Docker PostgreSQL)
6. Production Shopify app exists in Partner Dashboard with correct URLs
</verification>

<success_criteria>
- App is live at a stable Vercel URL (*.vercel.app)
- Neon PostgreSQL database is provisioned with all tables
- Production Shopify app credentials are configured in Vercel env vars
- shopify.app.production.toml reflects real production values
- Vercel auto-deploys on push to main branch
- Local development setup (ngrok) is completely unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-deploy-to-vercel/08-02-SUMMARY.md`
</output>
