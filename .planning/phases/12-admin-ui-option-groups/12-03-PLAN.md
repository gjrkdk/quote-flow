---
phase: 12-admin-ui-option-groups
plan: 03
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - app/routes/app.option-groups.$id.edit.tsx
autonomous: false

must_haves:
  truths:
    - "Merchant can see which products are assigned to an option group"
    - "Merchant can assign option groups to products from the option group edit page"
    - "Merchant can unassign an option group from a product"
    - "5 groups per product cap is enforced with UI feedback"
    - "Alphabetical display order is communicated to merchant"
  artifacts:
    - path: "app/routes/app.option-groups.$id.edit.tsx"
      provides: "Product assignment section on option group edit page"
      contains: "assignOptionGroupToProduct|unassignOptionGroupFromProduct"
  key_links:
    - from: "app/routes/app.option-groups.$id.edit.tsx"
      to: "app/services/option-group.server.ts"
      via: "assignOptionGroupToProduct, unassignOptionGroupFromProduct, and getProductOptionGroups service calls"
      pattern: "assignOptionGroupToProduct|unassignOptionGroupFromProduct"
---

<objective>
Add product assignment functionality to the option group edit page, allowing merchants to assign/unassign products to option groups and see which products use each group. Then verify the complete admin UI end-to-end.

Purpose: Merchants need to connect option groups to products so customers see option dropdowns on the storefront. This completes the OPT-04 requirement.
Output: Product assignment section on the option group edit page with assign/unassign actions and cap enforcement.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/12-admin-ui-option-groups/12-02-SUMMARY.md
@app/routes/app.matrices.$id.edit.tsx
@app/services/option-group.server.ts
@app/components/ProductPicker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add product assignment section to option group edit page</name>
  <files>app/routes/app.option-groups.$id.edit.tsx</files>
  <action>
Extend the option group edit page (created in Plan 02) to include a product assignment section below the choices form.

**Loader changes:**
- After fetching the option group, also query products assigned to this group
- Use Prisma to query `productOptionGroup` records where `optionGroupId = id`, include the `productMatrix` relation to get `productTitle` and `productId`
- Query: `prisma.productOptionGroup.findMany({ where: { optionGroupId: id }, include: { product: true } })` — note: `product` relation on ProductOptionGroup points to ProductMatrix
- Also fetch ALL products for the store (via ProductMatrix) that are NOT yet assigned to this group, for the "assign" dropdown
- Return additional data: `assignedProducts: [{ assignmentId, productId, productTitle, groupCount }]` and `availableProducts: [{ productId, productTitle }]`
- For each assigned product, include the count of option groups assigned to that product (for cap display)

**Action changes (add two new intents):**

`intent === "assign"`:
- Extract `productId` from formData
- Authenticate and find store
- Call `assignOptionGroupToProduct(productId, optionGroup.id, store.id)`
- Catch cap error ("Maximum 5 option groups per product") and return as json error
- On success: return `json({ success: true })`

`intent === "unassign"`:
- Extract `productId` from formData
- Call `unassignOptionGroupFromProduct(productId, optionGroup.id)`
- Return `json({ success: true })` or error

**Component changes:**

Add a new Card section below the existing choices card and save button, with:

1. **Header:** InlineStack with "Assigned Products" heading (headingMd)

2. **Assignment controls:** InlineStack with:
   - Select dropdown: label hidden, options are `[{ label: "Select a product to assign", value: "" }, ...availableProducts.map(p => ({ label: p.productTitle, value: p.productId }))]`
   - "Assign" Button: disabled when no product selected OR when assignedProducts include any product already at 5 groups
   - Use separate fetcher (assignFetcher) for assignment actions to avoid conflicts with the save fetcher

3. **Cap warning:** If any action returns cap error, show Banner tone="critical" with the error message

4. **Product list:** BlockStack of assigned products, each in a mini-card or InlineStack:
   - Product title (semibold)
   - Subdued text: "N option groups assigned" (shows how many groups this product has total)
   - "Remove" Button (plain, critical tone) that calls unassign intent
   - If product has 5 groups, show small Badge tone="warning" with "At limit"

5. **Empty state:** If no products assigned: Text tone="subdued" — "No products assigned. Select a product above to assign this option group."

6. **Help text:** Below the product list, Text tone="subdued": "Groups are displayed alphabetically by name on the product page."

**Implementation notes:**
- Use a SEPARATE useFetcher instance for assign/unassign (e.g., `const assignFetcher = useFetcher()`) to prevent conflicts with the save action
- The select dropdown should only show products that are NOT already assigned to this group
- After assign/unassign, Remix revalidation will automatically refresh the loader data
- productId values use the GID format (gid://shopify/Product/xxx) as stored in ProductMatrix.productId
  </action>
  <verify>
Run `npx tsc --noEmit`. Create an option group with choices, then navigate to its edit page. Verify the "Assigned Products" section appears below the form. If products exist in the store, the dropdown should show available products.
  </verify>
  <done>Option group edit page shows assigned products, allows assigning/unassigning products via dropdown and buttons, enforces 5-group cap with feedback, and communicates alphabetical display order.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete option groups admin UI</name>
  <files>app/routes/app.option-groups._index.tsx, app/routes/app.option-groups.new.tsx, app/routes/app.option-groups.$id.edit.tsx, app/routes/app.tsx</files>
  <action>
Human verification of the complete admin UI for option groups. All code has been implemented in Plans 01, 02, and 03 Task 1. This checkpoint verifies the full end-to-end flow works correctly in the browser.

Verification steps:
1. Start dev server: `npm run dev`
2. Open the app in Shopify admin
3. Verify "Option Groups" appears in sidebar navigation
4. Click "Option Groups" — should show empty state with "Create your first option group" CTA
5. Click "Create option group":
   - Enter name "Glass Type", set to Optional
   - Add 3 choices: "Standard Glass" (FIXED, 0), "Tempered Glass" (FIXED, 1500), "Low-E Glass" (PERCENTAGE, 2000)
   - Mark "Standard Glass" as default
   - Click "Create option group"
6. Verify redirect to edit page with all data pre-populated
7. Edit the name to "Glass Type v2", save — verify success banner
8. Scroll to "Assigned Products" section — verify it shows available products dropdown
9. Assign a product — verify it appears in the assigned list
10. Go back to list page — verify "Glass Type v2" appears with correct counts
11. Create a second option group "Edge Finish" with choices
12. Try to delete "Glass Type v2" from list page — verify modal shows product warning
13. Confirm delete — verify it's removed from list
  </action>
  <verify>User confirms all 13 verification steps pass by typing "approved".</verify>
  <done>Complete admin UI for option groups verified: navigation, list, create, edit, assign, delete all work correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without new errors
2. Products can be assigned to option groups from the edit page
3. Products can be unassigned from option groups
4. 5-group-per-product cap is enforced with error message
5. Dropdown only shows products not already assigned to this group
6. Alphabetical display order help text is visible
7. Full end-to-end flow works: create group -> add choices -> assign products -> verify in list
</verification>

<success_criteria>
- Product assignment section visible on option group edit page
- Assign and unassign operations work correctly
- Cap enforcement (5 groups per product) with UI feedback
- Available products dropdown excludes already-assigned products
- Alphabetical display order communicated via help text
- Full admin UI verified by human: navigation, list, create, edit, assign, delete
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-ui-option-groups/12-03-SUMMARY.md`
</output>
