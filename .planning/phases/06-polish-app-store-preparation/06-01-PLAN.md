---
phase: 06-polish-app-store-preparation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/services/csv-parser.server.ts
  - app/services/csv-parser.server.test.ts
autonomous: true

must_haves:
  truths:
    - "CSV with valid width, height, price columns parses into structured grid data"
    - "Invalid rows are collected with line numbers and specific error messages"
    - "Grid is inferred from unique width and height values"
    - "Files over 1MB are rejected before parsing"
    - "Empty CSV or CSV with only headers returns meaningful error"
  artifacts:
    - path: "app/services/csv-parser.server.ts"
      provides: "CSV parsing and validation logic"
      exports: ["parseMatrixCSV"]
    - path: "app/services/csv-parser.server.test.ts"
      provides: "Test coverage for CSV parser"
      min_lines: 80
  key_links:
    - from: "app/services/csv-parser.server.ts"
      to: "csv-parse"
      via: "import parse"
      pattern: "import.*csv-parse"
---

<objective>
Implement CSV parsing service with TDD for matrix import. The service accepts a CSV string with 3 columns (width, height, price), validates each row, collects errors with line numbers, and returns a structured grid preview (unique widths, unique heights, cell map).

Purpose: CSV parsing is the business logic foundation for MATRIX-07 (CSV import). TDD ensures correct handling of edge cases: malformed rows, duplicate entries, non-numeric values, missing columns.

Output: Tested `parseMatrixCSV` function that transforms raw CSV into preview-ready data.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-polish-app-store-preparation/06-CONTEXT.md
@.planning/phases/06-polish-app-store-preparation/06-RESEARCH.md
</context>

<feature>
  <name>CSV Matrix Parser</name>
  <files>app/services/csv-parser.server.ts, app/services/csv-parser.server.test.ts</files>
  <behavior>
    parseMatrixCSV(csvContent: string): Promise&lt;CSVParseResult&gt;

    Interface:
    ```typescript
    interface CSVParseResult {
      success: boolean;
      widths: number[];       // sorted unique width values
      heights: number[];      // sorted unique height values
      cells: Map<string, number>;  // "widthIdx,heightIdx" -> price
      errors: Array<{ line: number; message: string }>;
      totalRows: number;
      validRows: number;
    }
    ```

    Cases:
    - Valid 3x3 CSV -> success=true, 3 widths, 3 heights, 9 cells, 0 errors
    - CSV with "width,height,price" header -> header skipped, data parsed from row 2
    - Row with non-numeric width -> error: "line 3: width must be a positive number"
    - Row with negative price -> error: "line 5: price must be a non-negative number"
    - Row with missing column -> error: "line 4: expected 3 columns, got 2"
    - Duplicate width/height pair -> last value wins (overwrite)
    - Empty CSV -> success=false, error: "CSV file is empty or contains only headers"
    - CSV > 1MB -> success=false, error: "CSV file must be under 1MB"
    - Mixed valid/invalid rows -> success=true, valid rows in grid, errors collected
    - Widths/heights sorted numerically ascending in output
  </behavior>
  <implementation>
    First install csv-parse: `npm install csv-parse`

    Use csv-parse with options:
    - columns: false (manual column mapping for better error messages)
    - skip_empty_lines: true
    - trim: true
    - relax_column_count: true (to catch missing columns ourselves)

    File size check: validate csvContent.length before parsing (1MB = 1,048,576 bytes).

    Parse flow:
    1. Check file size
    2. Detect and skip header row (first row with "width" or "height" text)
    3. For each row: validate 3 columns, parse as numbers, validate ranges
    4. Collect unique widths and heights, sort ascending
    5. Build cell map with position indices matching sorted breakpoints
    6. Return CSVParseResult

    Key: Use `from_line: 2` only if header detected. Otherwise parse from line 1.
  </implementation>
</feature>

<verification>
- `npx vitest run app/services/csv-parser.server.test.ts` passes all tests
- At least 8 test cases covering: valid input, empty input, oversized input, malformed rows, missing columns, negative values, duplicate entries, header detection
</verification>

<success_criteria>
- parseMatrixCSV correctly parses valid 3-column CSV into grid structure
- All invalid rows collected with line numbers and specific messages
- Unique widths/heights extracted and sorted ascending
- Cell map uses position indices matching sorted breakpoints
- File size limit enforced at 1MB
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-app-store-preparation/06-01-SUMMARY.md`
</output>
