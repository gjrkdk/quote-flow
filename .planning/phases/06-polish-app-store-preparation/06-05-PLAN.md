---
phase: 06-polish-app-store-preparation
plan: 05
type: execute
wave: 2
depends_on: ["06-02", "06-03"]
files_modified:
  - app/routes/app.matrices._index.tsx
  - .planning/phases/06-polish-app-store-preparation/APP_STORE_LISTING.md
autonomous: false

must_haves:
  truths:
    - "Focus moves to next item or empty state after matrix delete"
    - "Security review items verified: session tokens, GDPR webhooks, billing, scopes"
    - "App Store listing copy is drafted with app name, description, and feature list"
    - "All critical UI flows verified visually on desktop and tablet"
  artifacts:
    - path: "app/routes/app.matrices._index.tsx"
      provides: "Matrix list with focus management after delete"
      contains: "focus"
    - path: ".planning/phases/06-polish-app-store-preparation/APP_STORE_LISTING.md"
      provides: "App Store listing draft"
      contains: "Price Matrix"
  key_links:
    - from: "app/routes/app.matrices._index.tsx"
      to: "focus management"
      via: "useEffect or ref focus after delete"
      pattern: "\\.focus\\(\\)"
---

<objective>
Complete polish items: focus management after delete in matrix list, security review verification, App Store listing copy draft, and human verification of the complete phase.

Purpose: Final polish before App Store submission. Focus management is an accessibility requirement. Security review catches any compliance gaps. Listing copy is needed for submission.

Output: Accessible matrix list, security verification, listing draft, human sign-off on all Phase 6 work.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-polish-app-store-preparation/06-CONTEXT.md
@.planning/phases/06-polish-app-store-preparation/06-03-SUMMARY.md
@app/routes/app.matrices._index.tsx
@app/shopify.server.ts
@app/routes/webhooks.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add focus management after delete and security review</name>
  <files>app/routes/app.matrices._index.tsx, .planning/phases/06-polish-app-store-preparation/APP_STORE_LISTING.md</files>
  <action>
    **Focus Management in app.matrices._index.tsx:**
    - Track which matrix was just deleted using state or fetcher data
    - After a successful delete action response, use `useEffect` to manage focus:
      - If matrices remain: focus the next matrix row (or previous if last was deleted). Use a ref on each IndexTable.Row or the row's primary action element.
      - If no matrices remain (empty state): focus the "Create matrix" button or the EmptyState heading. Add `id="create-matrix-btn"` to the primary action button for reliable focus targeting.
    - Implementation approach: After delete fetcher completes, set a `focusTarget` state (e.g., the index of the next matrix). Use `useEffect` watching `focusTarget` to call `.focus()` on the appropriate element.
    - Add `tabIndex={-1}` to the focusable target elements if they aren't natively focusable (e.g., table rows) so they can receive programmatic focus.

    **Security Review Checklist (verify and document):**
    Scan existing code to verify all Shopify mandatory requirements:

    1. Session Tokens: Verify `unstable_newEmbeddedAuthStrategy: true` in shopify.server.ts
    2. GDPR Webhooks: Verify CUSTOMERS_DATA_REQUEST, CUSTOMERS_REDACT, SHOP_REDACT in shopify.server.ts webhooks config AND that webhooks.tsx handles them
    3. Billing API: Verify billing config exists in shopify.server.ts (from Plan 02)
    4. Appropriate Scopes: Check .env or shopify.app.toml for scopes - should be minimal (write_products, read_products, write_draft_orders)
    5. App Bridge: Verify @shopify/app-bridge-react is used in app.tsx
    6. No Unprotected Customer Data: Verify no protected customer data scopes requested beyond what's needed

    Document findings as inline comments in the listing file.

    **App Store Listing Draft:**
    Create `.planning/phases/06-polish-app-store-preparation/APP_STORE_LISTING.md` with:

    - App Name: "Price Matrix"
    - Tagline: "Dimension-based pricing for custom products" (under 80 chars)
    - Description (200-300 words): Friendly, merchant-focused copy emphasizing:
      - Easy setup of width x height pricing grids
      - Assign to any product
      - Real-time pricing for headless storefronts via API and React widget
      - Draft Order integration for accurate checkout pricing
      - CSV import for bulk setup (paid feature)
      - Free to start (1 matrix), upgrade for unlimited
    - Key Features list (5-7 bullet points)
    - Pricing Section:
      - Free: 1 matrix, full functionality
      - Unlimited ($12/mo): Unlimited matrices, CSV import, 14-day free trial
    - Screenshot Descriptions (what to capture, NOT the screenshots themselves):
      1. Dashboard overview with active matrix count
      2. Matrix grid editor showing spreadsheet-like price editing
      3. Product assignment with Shopify products
      4. Widget preview showing customer-facing dimension inputs
      5. CSV import preview showing parsed grid
    - Category suggestions for Shopify App Store
    - Keywords: pricing, custom dimensions, price matrix, headless, draft orders

    Tone: Per CONTEXT.md - friendly and accessible, speaks to all merchants, emphasizes ease of use.
    Do NOT include pricing amounts in screenshot descriptions.
    Do NOT include testimonials or claims.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Focus management code exists in app.matrices._index.tsx (grep for ".focus()"). APP_STORE_LISTING.md exists with all sections.
  </verify>
  <done>Matrix list has focus management after delete. Security review checklist verified. App Store listing drafted with all required sections.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 6 Polish:
    1. CSV import on create matrix page (file upload, preview, confirm, freemium gate)
    2. ARIA grid keyboard navigation in matrix editor (arrow keys, Enter, Escape)
    3. Responsive layout: dashboard 2-col/1-col, matrix list full-width
    4. Focus management after delete in matrix list
    5. Billing/freemium: 1 free matrix, $12/mo unlimited
    6. App Store listing draft
  </what-built>
  <how-to-verify>
    Start the dev server: `npx shopify app dev --tunnel-url https://fagaceous-rana-carbolated.ngrok-free.dev:9292`

    **1. CSV Import Flow (paid tier test):**
    a. Navigate to Matrices > Create Matrix
    b. Verify 4 template options visible: Small, Medium, Custom, CSV Import
    c. Select "CSV Import" - if upgrade prompt appears, approve the test billing
    d. Upload a CSV file with content like:
       ```
       width,height,price
       10,10,5.00
       10,20,8.00
       20,10,7.50
       20,20,12.00
       ```
    e. Verify preview shows 2x2 grid with correct prices
    f. Click "Create Matrix" - verify redirect to matrix editor with populated grid

    **2. Keyboard Navigation (matrix editor):**
    a. Open any matrix editor
    b. Click on a price cell, then use arrow keys to move between cells
    c. Verify: ArrowRight/Left moves columns, ArrowUp/Down moves rows
    d. Press Enter on a cell - verify input becomes focused/editable
    e. Press Escape - verify focus returns to cell (not input)
    f. Press Tab - verify focus leaves grid entirely (goes to next page element)

    **3. Responsive Layout:**
    a. Open dashboard at full desktop width - verify cards in 2-column layout
    b. Resize browser to ~768px (tablet) - verify cards stack to single column
    c. Open matrix list at tablet width - verify full-width table
    d. Open matrix editor at tablet width - verify horizontal scroll works

    **4. Focus After Delete:**
    a. Navigate to matrix list with 2+ matrices
    b. Delete a matrix (not the last one)
    c. Verify focus moves to next matrix row (not lost to body)
    d. Delete last remaining matrix
    e. Verify focus moves to "Create matrix" button or empty state

    **5. Free Tier Limit:**
    a. If possible, test with a store that has 1 matrix on free plan
    b. Try to create another matrix - verify upgrade banner appears
    c. Verify CSV Import shows upgrade prompt for free stores

    **6. App Store Listing:**
    a. Review APP_STORE_LISTING.md in .planning/phases/06-polish-app-store-preparation/
    b. Verify tone is friendly and accessible
    c. Verify no pricing in screenshot descriptions
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All TypeScript compiles
- Focus management works after matrix delete
- Security checklist items verified
- App Store listing complete
- Human verification of all Phase 6 features
</verification>

<success_criteria>
- Focus properly managed after delete operations
- Security review passes (session tokens, GDPR, billing, scopes)
- App Store listing ready for submission
- Human approves all Phase 6 work
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-app-store-preparation/06-05-SUMMARY.md`
</output>
