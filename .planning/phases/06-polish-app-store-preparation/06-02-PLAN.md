---
phase: 06-polish-app-store-preparation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/shopify.server.ts
  - app/services/billing.server.ts
autonomous: true

must_haves:
  truths:
    - "Shopify Billing API is configured with a freemium plan"
    - "Free tier allows 1 matrix, paid tier allows unlimited"
    - "Billing check utility can determine if store has active paid plan"
    - "Matrix count enforcement prevents free stores from creating more than 1 matrix"
  artifacts:
    - path: "app/services/billing.server.ts"
      provides: "Billing check and plan enforcement utilities"
      exports: ["checkBillingStatus", "requirePaidPlan", "PLAN_NAME", "PLAN_PRICE"]
    - path: "app/shopify.server.ts"
      provides: "Shopify app config with billing"
      contains: "billing"
  key_links:
    - from: "app/services/billing.server.ts"
      to: "app/shopify.server.ts"
      via: "authenticate.admin for billing.check"
      pattern: "billing\\.check"
---

<objective>
Set up Shopify Billing API for freemium model and create billing check utilities. Free tier: 1 matrix with full functionality. Paid tier ($12/mo with 14-day trial): unlimited matrices + CSV import.

Purpose: Freemium gate is required for App Store submission and enables the business model. CSV import (Plan 04) and matrix creation both need billing checks.

Output: Billing configuration in shopify.server.ts and utility functions for checking/enforcing plans.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-polish-app-store-preparation/06-CONTEXT.md
@.planning/phases/06-polish-app-store-preparation/06-RESEARCH.md
@app/shopify.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Shopify Billing API</name>
  <files>app/shopify.server.ts</files>
  <action>
    Add billing configuration to the shopifyApp() call in shopify.server.ts. Configure a single subscription plan:
    - Plan name: "UNLIMITED_PLAN"
    - Amount: 12.00
    - Currency: "USD"
    - Interval: "EVERY_30_DAYS"
    - Trial days: 14
    - Replacement behavior: "APPLY_IMMEDIATELY" (for plan changes)

    Add the billing config object to the shopifyApp initialization. The billing property should define the plan with the above parameters. Reference Shopify Billing API docs pattern:
    ```
    billing: {
      UNLIMITED_PLAN: {
        amount: 12.0,
        currencyCode: "USD",
        interval: BillingInterval.Every30Days,
        trialDays: 14,
        replacementBehavior: BillingReplacementBehavior.ApplyImmediately,
      },
    },
    ```

    Import BillingInterval and BillingReplacementBehavior from "@shopify/shopify-app-remix/server".
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes without billing-related errors.</verify>
  <done>shopify.server.ts has billing configuration with UNLIMITED_PLAN at $12/mo with 14-day trial.</done>
</task>

<task type="auto">
  <name>Task 2: Create billing check utilities</name>
  <files>app/services/billing.server.ts</files>
  <action>
    Create app/services/billing.server.ts with the following exports:

    Constants:
    - PLAN_NAME = "UNLIMITED_PLAN"
    - PLAN_PRICE = "$12/month"
    - FREE_MATRIX_LIMIT = 1
    - PLAN_FEATURES = ["Unlimited matrices", "CSV import"]

    Function: checkBillingStatus(request: Request)
    - Calls authenticate.admin(request) to get billing object
    - Calls billing.check({ plans: [PLAN_NAME], isTest: true })
    - Returns { hasActivePayment: boolean, needsUpgrade: boolean }
    - Note: isTest should be true for development, will need to be environment-aware for production. For now use `process.env.NODE_ENV !== "production"` or just hardcode true (dev).

    Function: requirePaidPlan(request: Request)
    - Calls checkBillingStatus
    - If not paid, returns { needsUpgrade: true, plan: PLAN_NAME, price: PLAN_PRICE, features: PLAN_FEATURES }
    - If paid, returns { needsUpgrade: false }

    Function: canCreateMatrix(request: Request, currentMatrixCount: number)
    - If currentMatrixCount < FREE_MATRIX_LIMIT, returns { allowed: true }
    - Otherwise checks billing status
    - If paid, returns { allowed: true }
    - If free, returns { allowed: false, reason: "free_limit", limit: FREE_MATRIX_LIMIT }

    Import authenticate from "~/shopify.server". Use proper TypeScript types for all return values.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes. File exists with all 3 exported functions.</verify>
  <done>billing.server.ts exports checkBillingStatus, requirePaidPlan, canCreateMatrix with proper typing. Shopify Billing API integration configured for freemium model.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- app/shopify.server.ts contains billing config with UNLIMITED_PLAN
- app/services/billing.server.ts exports all utility functions
- Plan price is $12/mo per discretion decision
- 14-day trial configured
- Free limit is 1 matrix
</verification>

<success_criteria>
- Billing API configured in shopify.server.ts
- Utility functions ready for use by matrix creation route and CSV import
- Free tier enforces 1 matrix limit
- Paid tier check available for CSV import gating
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-app-store-preparation/06-02-SUMMARY.md`
</output>
