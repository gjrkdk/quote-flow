---
phase: 06-polish-app-store-preparation
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - app/routes/app.matrices.new.tsx
autonomous: true

must_haves:
  truths:
    - "Merchant sees CSV Import option alongside Small, Medium, Custom templates on create matrix page"
    - "Selecting CSV Import shows a file upload area"
    - "After upload, merchant sees a preview grid with parsed dimensions and prices"
    - "Invalid rows are highlighted with specific error messages and line numbers"
    - "Merchant can confirm to create the matrix or cancel to go back"
    - "Free-tier merchants see an upgrade prompt instead of the file picker"
    - "Matrix creation via CSV creates all breakpoints and cells in one transaction"
    - "Free-tier merchants cannot create more than 1 matrix (any template)"
  artifacts:
    - path: "app/routes/app.matrices.new.tsx"
      provides: "Create matrix page with CSV import, freemium gate, and preview flow"
      contains: "parseMatrixCSV"
  key_links:
    - from: "app/routes/app.matrices.new.tsx"
      to: "app/services/csv-parser.server.ts"
      via: "import parseMatrixCSV"
      pattern: "import.*parseMatrixCSV.*csv-parser"
    - from: "app/routes/app.matrices.new.tsx"
      to: "app/services/billing.server.ts"
      via: "import canCreateMatrix, requirePaidPlan"
      pattern: "import.*billing"
    - from: "app/routes/app.matrices.new.tsx"
      to: "prisma transaction"
      via: "prisma.$transaction for CSV matrix creation"
      pattern: "prisma\\.\\$transaction"
---

<objective>
Add CSV import option to the create matrix page with file upload, preview grid, confirmation flow, and freemium gating. Also enforce free-tier matrix limit (1 matrix) for all creation paths.

Purpose: Implements MATRIX-07 (CSV import) and freemium business model. Merchants can bulk-create matrices from CSV while the free/paid tier distinction drives upgrades.

Output: Enhanced create matrix page with 4 template options (Small, Medium, Custom, CSV Import) and full CSV import flow.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-polish-app-store-preparation/06-CONTEXT.md
@.planning/phases/06-polish-app-store-preparation/06-RESEARCH.md
@.planning/phases/06-polish-app-store-preparation/06-01-SUMMARY.md
@.planning/phases/06-polish-app-store-preparation/06-02-SUMMARY.md
@app/routes/app.matrices.new.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSV import template option with file upload and preview</name>
  <files>app/routes/app.matrices.new.tsx</files>
  <action>
    Modify app/routes/app.matrices.new.tsx to add CSV import as a 4th template option.

    **Loader Changes:**
    - Import `canCreateMatrix` from `~/services/billing.server`
    - Import `checkBillingStatus` from `~/services/billing.server`
    - Count current matrices for the store: `prisma.priceMatrix.count({ where: { storeId: store.id } })`
    - Call `canCreateMatrix(request, matrixCount)` to determine creation permission
    - Call `checkBillingStatus(request)` to determine if store has paid plan (for CSV gate)
    - Return `{ unitPreference, canCreate: canCreateResult, hasPaidPlan: billingStatus.hasActivePayment }`

    **UI Changes - Template Selection:**
    - Add 4th choice to ChoiceList:
      ```
      {
        label: "CSV Import",
        value: "csv",
        helpText: "Upload a CSV file with width, height, price columns",
      }
      ```
    - Update Template type to include "csv": `type Template = "small" | "medium" | "custom" | "csv";`

    **UI Changes - CSV Upload Area:**
    - When template is "csv", show a file upload section below the ChoiceList (conditionally rendered)
    - Use a `<DropZone>` from Polaris with `accept=".csv"` and `type="file"` for the upload
    - If store does NOT have paid plan (`hasPaidPlan === false`):
      - Instead of DropZone, show a Polaris `Banner` with tone="info":
        - Title: "CSV Import is a paid feature"
        - Body: "Import hundreds of prices at once from a CSV file. Upgrade to the Unlimited plan for $12/month."
        - Action: Button "Upgrade" that triggers billing request (submit form with intent="upgrade")
    - If store HAS paid plan:
      - Show DropZone for CSV file upload
      - On file select, read file content client-side using FileReader
      - Submit file content to server action with intent="preview_csv"

    **UI Changes - Free Tier Matrix Limit:**
    - If `canCreate.allowed === false`, show a Banner at the top of the page:
      - Title: "Free plan limit reached"
      - Body: "Your free plan includes 1 matrix. Upgrade to create unlimited matrices."
      - Action: "Upgrade" button (intent="upgrade")
    - Disable the Create button when canCreate.allowed is false (for all templates, not just CSV)

    **Action Changes - CSV Preview:**
    - Add intent="preview_csv" handler:
      - Get csvContent from formData
      - Import and call `parseMatrixCSV(csvContent)` from `~/services/csv-parser.server`
      - Call `requirePaidPlan(request)` - if needsUpgrade, return error
      - Return json with: `{ intent: "preview_csv", preview: parseResult }`

    **Action Changes - CSV Confirm:**
    - Add intent="confirm_csv" handler:
      - Re-parse the CSV (or receive the data from hidden form fields)
      - Call `requirePaidPlan(request)` again (security check)
      - Call `canCreateMatrix(request, currentCount)` (security check)
      - Create matrix in Prisma transaction (same pattern as existing template creation):
        1. Create PriceMatrix with name from form
        2. Create width Breakpoints from parsed unique widths (sorted, position = index)
        3. Create height Breakpoints from parsed unique heights (sorted, position = index)
        4. Create MatrixCells for each width/height combination with parsed prices
      - Redirect to `/app/matrices/${newMatrix.id}/edit`

    **Action Changes - Upgrade:**
    - Add intent="upgrade" handler:
      - Call `authenticate.admin(request)` to get billing
      - Call `billing.request({ plan: "UNLIMITED_PLAN", isTest: true })` to redirect merchant to Shopify billing approval page

    **Action Changes - Enforce Free Limit on ALL Templates:**
    - Before creating any matrix (small, medium, custom, csv), check `canCreateMatrix(request, currentCount)`
    - If not allowed, return error: "Free plan limit reached. Upgrade to create more matrices."

    **UI Changes - Preview Display:**
    - When actionData has intent="preview_csv", show preview section:
      - Banner showing: "{validRows} valid rows, {errors.length} errors found, Grid: {widths.length} x {heights.length}"
      - If errors exist, show them in a collapsible list with Polaris `Collapsible`:
        - Each error shows: "Row {line}: {message}" in red/critical tone
      - Show a preview table (read-only, using simple HTML table):
        - Column headers = parsed widths (sorted)
        - Row headers = parsed heights (sorted)
        - Cell values = parsed prices
        - Style similar to MatrixGrid but non-editable
      - Two buttons: "Create Matrix" (submits intent="confirm_csv" with the CSV data in a hidden textarea) and "Cancel" (resets to upload state)

    **Form Handling:**
    - The page needs multiple form submissions (preview, confirm, upgrade). Use Remix `useFetcher` or multiple `<Form>` elements with different intents.
    - Store CSV content in component state after first upload. On confirm, send it again in a hidden field.
    - Use `encType="multipart/form-data"` for the initial file upload OR read file client-side and send as text field.

    Recommendation: Read file client-side with FileReader, store in state, send as hidden text field. Simpler than multipart handling.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Manually verify the page loads without errors by checking build: `npx remix build` or `npx vite build`.
  </verify>
  <done>
    Create matrix page has 4 template options. CSV import shows file upload (paid) or upgrade prompt (free). Preview step shows parsed grid with errors. Confirm creates matrix via transaction. Free tier limit enforced for all templates. Upgrade flow triggers Shopify billing.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- app.matrices.new.tsx imports parseMatrixCSV and billing utilities
- CSV template option visible in ChoiceList
- Free tier gate logic present for CSV import
- Matrix count limit enforced for all creation paths
- Preview and confirm flow implemented
</verification>

<success_criteria>
- CSV Import appears as 4th template option on create matrix page
- File upload works for paid merchants, upgrade banner for free merchants
- CSV preview shows grid with dimensions, prices, and inline errors
- Confirm creates matrix with all breakpoints and cells
- Free tier cannot create more than 1 matrix (any template)
- Upgrade button triggers Shopify billing flow
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-app-store-preparation/06-04-SUMMARY.md`
</output>
