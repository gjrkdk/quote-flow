---
phase: 04-public-rest-api
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "External client receives price JSON for valid product + dimensions + API key"
    - "External client receives 401 for missing or invalid API key"
    - "External client receives 400 for invalid or out-of-range dimensions"
    - "External client receives 404 for product with no matrix"
    - "Between-breakpoint dimensions return rounded-up price"
  artifacts: []
  key_links: []
---

<objective>
Verify the public REST API works end-to-end by testing with curl against the running dev server.

Purpose: Human verification ensures the full request flow works — from HTTP request through authentication, validation, database lookup, price calculation, and JSON response. This catches integration issues that unit tests miss (route registration, database state, Shopify CLI proxy routing).

Output: Verified API endpoint ready for Phase 5 (React Widget) integration
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-public-rest-api/04-01-SUMMARY.md
@.planning/phases/04-public-rest-api/04-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Public REST API endpoint at `/api/v1/products/:productId/price` with:
    - API key authentication via X-API-Key header
    - Zod input validation for dimensions
    - Price calculation with round-up behavior
    - RFC 7807 error responses
    - CORS headers
    - Rate limiting
  </what-built>
  <how-to-verify>
    Prerequisites:
    - Dev server running (`shopify app dev`)
    - At least one price matrix exists with assigned product
    - Store has an API key generated (check dashboard)

    Get your test data:
    1. Open the app dashboard and note your API key (generate one if needed)
    2. Open a matrix and note a product ID assigned to it
    3. Note the matrix breakpoints (width and height values)

    Run these curl tests from terminal (replace placeholders):

    **Test 1: Success case (exact breakpoint match)**
    ```bash
    curl -s -H "X-API-Key: YOUR_API_KEY" \
      "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/PRODUCT_ID/price?width=WIDTH&height=HEIGHT" | jq .
    ```
    Expected: 200 with `{ "price": ..., "dimensions": {...}, "quantity": 1, "total": ... }`

    **Test 2: Success case (between breakpoints — round up)**
    Use dimensions between two breakpoints (e.g., if breakpoints are 300, 600, use width=450).
    Expected: 200 with price matching the next-higher breakpoint

    **Test 3: Missing API key**
    ```bash
    curl -s "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/PRODUCT_ID/price?width=300&height=200" | jq .
    ```
    Expected: 401 with `{ "title": "Unauthorized", "detail": "X-API-Key header is required" }`

    **Test 4: Invalid API key**
    ```bash
    curl -s -H "X-API-Key: pm_invalidkey1234567890" \
      "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/PRODUCT_ID/price?width=300&height=200" | jq .
    ```
    Expected: 401 with `{ "title": "Unauthorized", "detail": "Invalid API key" }`

    **Test 5: Missing dimensions**
    ```bash
    curl -s -H "X-API-Key: YOUR_API_KEY" \
      "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/PRODUCT_ID/price" | jq .
    ```
    Expected: 400 with validation errors for width and height

    **Test 6: Product with no matrix**
    ```bash
    curl -s -H "X-API-Key: YOUR_API_KEY" \
      "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/9999999999999/price?width=300&height=200" | jq .
    ```
    Expected: 404 with `{ "title": "Not Found", "detail": "No price matrix assigned to this product" }`

    **Test 7: CORS headers present**
    ```bash
    curl -s -I -H "X-API-Key: YOUR_API_KEY" \
      "https://fagaceous-rana-carbolated.ngrok-free.dev/api/v1/products/PRODUCT_ID/price?width=300&height=200" | grep -i "access-control"
    ```
    Expected: `Access-Control-Allow-Origin: *` header present

    Verify all 7 tests pass.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed and the actual responses</resume-signal>
</task>

</tasks>

<verification>
All curl tests from the checkpoint pass:
1. Valid request returns correct price with 200
2. Between-breakpoint dimensions return rounded-up price
3. Missing API key returns 401
4. Invalid API key returns 401
5. Missing dimensions return 400
6. Unmatched product returns 404
7. CORS headers present on responses
</verification>

<success_criteria>
Phase 4 success criteria (from ROADMAP.md) verified:
1. External client can send GET request to `/api/v1/products/:id/price?width=18&height=30` with valid API key and receive price response
2. API returns 401 Unauthorized for requests without valid X-API-Key header
3. API returns rounded-up price when customer dimensions fall between defined breakpoints
4. API returns 400 Bad Request with error message when dimensions exceed matrix range or product has no assigned matrix
</success_criteria>

<output>
After completion, create `.planning/phases/04-public-rest-api/04-03-SUMMARY.md`
</output>
