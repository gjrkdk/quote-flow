---
phase: 03-draft-orders-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - app/services/draft-order.server.ts
  - app/routes/app.matrices.$id.edit.tsx
  - app/routes/app._index.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "Merchant can enter width, height, and quantity on matrix edit page and create a real Draft Order in Shopify"
    - "Draft Order in Shopify admin has correct custom price (not product default), product dimensions as custom attributes, and price-matrix tag"
    - "Draft Order record is saved locally with all dimensions, price, and Shopify order details"
    - "Dashboard shows total Draft Orders created count"
    - "Shopify API failures are retried with exponential backoff (up to 3 attempts)"
    - "Products without an assigned matrix show clear error when attempting Draft Order creation"
  artifacts:
    - path: "app/services/draft-order.server.ts"
      provides: "Draft Order creation via Shopify GraphQL with retry logic and local record saving"
      exports: ["createDraftOrder"]
      min_lines: 80
    - path: "app/routes/app.matrices.$id.edit.tsx"
      provides: "Test Draft Order flow UI at bottom of matrix edit page"
      contains: "create-test-draft-order"
    - path: "app/routes/app._index.tsx"
      provides: "Dashboard with Draft Orders created count"
      contains: "totalDraftOrdersCreated"
  key_links:
    - from: "app/routes/app.matrices.$id.edit.tsx"
      to: "app/services/draft-order.server.ts"
      via: "action handler calling createDraftOrder"
      pattern: "createDraftOrder"
    - from: "app/services/draft-order.server.ts"
      to: "app/services/price-calculator.server.ts"
      via: "import calculatePrice for price lookup"
      pattern: "import.*calculatePrice.*price-calculator"
    - from: "app/services/draft-order.server.ts"
      to: "Shopify GraphQL API"
      via: "admin.graphql draftOrderCreate mutation"
      pattern: "draftOrderCreate"
    - from: "app/services/draft-order.server.ts"
      to: "prisma.draftOrderRecord"
      via: "Prisma transaction to save record + increment counter"
      pattern: "draftOrderRecord.create"
---

<objective>
Build the Draft Order creation service, add test flow UI to the matrix edit page, and display Draft Order count on the dashboard. This connects the price calculator (Plan 01) and database schema (Plan 02) into a working end-to-end flow where merchants can verify matrix pricing by creating real Draft Orders in Shopify.

Purpose: This is the core deliverable of Phase 3 -- the ability to create Shopify Draft Orders with custom matrix-calculated pricing. The test flow UI doubles as merchant onboarding verification and Phase 3 end-to-end validation.

Output: Working Draft Order creation with test UI and dashboard counter.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-draft-orders-integration/03-CONTEXT.md
@.planning/phases/03-draft-orders-integration/03-RESEARCH.md
@.planning/phases/03-draft-orders-integration/03-01-SUMMARY.md
@.planning/phases/03-draft-orders-integration/03-02-SUMMARY.md
@prisma/schema.prisma
@app/routes/app.matrices.$id.edit.tsx
@app/routes/app._index.tsx
@app/services/price-calculator.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install exponential-backoff and create Draft Order service</name>
  <files>package.json, app/services/draft-order.server.ts</files>
  <action>
    1. Install the exponential-backoff package:
       `npm install exponential-backoff`

    2. Create `app/services/draft-order.server.ts` with a `createDraftOrder()` function that:

    **Function signature:**
    ```typescript
    interface CreateDraftOrderInput {
      admin: any; // Shopify admin GraphQL client from authenticate.admin
      storeId: string;
      matrixId: string;
      productId: string; // GID format
      variantId: string; // GID format — must be queried from Shopify
      productTitle: string;
      width: number; // in mm (internal unit)
      height: number; // in mm (internal unit)
      quantity: number;
      unitPreference: string; // "mm" or "cm" for display
    }

    interface CreateDraftOrderResult {
      success: boolean;
      draftOrder?: {
        id: string;
        name: string;
        totalPrice: string;
      };
      error?: string;
    }
    ```

    **Implementation steps inside createDraftOrder:**

    a. **Load matrix data** from database using Prisma:
       - Fetch matrix with widthBreakpoints (axis="width"), heightBreakpoints (axis="height"), and cells
       - Verify matrix exists and belongs to storeId
       - If matrix not found, return `{ success: false, error: "Matrix not found" }`

    b. **Validate dimensions** using `validateDimensions(width, height, quantity)` from price-calculator.server.ts
       - If invalid, return the validation error

    c. **Calculate price** using `calculatePrice(width, height, matrixData)` from price-calculator.server.ts
       - Transform Prisma breakpoint data into the MatrixData format expected by calculatePrice
       - Separate breakpoints by axis, sort by position

    d. **Format dimensions for display** based on unitPreference:
       - If "mm": show as-is (e.g., "180mm")
       - If "cm": convert mm to cm by dividing by 10 (e.g., "18cm")

    e. **Query Shopify for product variant** if variantId not provided:
       - Use `admin.graphql` to query first variant of the product
       - GraphQL query: `query { product(id: $productId) { variants(first: 1) { edges { node { id } } } } }`
       - If no variant found, return error

    f. **Create Draft Order** via Shopify GraphQL with exponential backoff:
       - Use `backOff` from `exponential-backoff` package
       - GraphQL mutation `draftOrderCreate` with input:
         - `lineItems`: one item with `variantId`, `quantity`, `originalUnitPrice` (the calculated price), and `customAttributes` for Width and Height (formatted with unit)
         - `tags`: `["price-matrix"]`
       - Retry config: numOfAttempts: 3, startingDelay: 1000, timeMultiple: 2, maxDelay: 5000, jitter: "full"
       - Only retry on rate limit errors (429 status), NOT on GraphQL userErrors
       - Check `userErrors` array before accessing `draftOrder` (see Research pitfall #1)

    g. **Save local record** in Prisma transaction:
       - Create DraftOrderRecord with all fields
       - Increment `store.totalDraftOrdersCreated` by 1
       - Use `prisma.$transaction()` for atomicity

    h. **Return result** with draftOrder id, name, and totalPrice

    **Also create a helper function `getProductVariant(admin, productId)`** that queries Shopify for the first variant of a product. This is needed because ProductMatrix stores productId but Draft Orders require variantId.

    **Error handling patterns:**
    - GraphQL userErrors: Extract field + message, return as error string
    - Rate limit (429): Retried automatically by backOff
    - Network errors: Let backOff retry, then surface error
    - Missing matrix/product: Early return with clear error message
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Package installed: `npm ls exponential-backoff` shows it installed
  </verify>
  <done>draft-order.server.ts exports createDraftOrder() that calculates price, creates Shopify Draft Order with custom pricing, and saves local record with retry logic.</done>
</task>

<task type="auto">
  <name>Task 2: Add test Draft Order UI to matrix edit page and dashboard counter</name>
  <files>app/routes/app.matrices.$id.edit.tsx, app/routes/app._index.tsx</files>
  <action>
    **Matrix Edit Page — Test Draft Order Card:**

    Add a new Card section at the bottom of the matrix edit page (after the ProductPicker component) with title "Test Draft Order". This card allows merchants to create a real Draft Order in Shopify to verify pricing works.

    UI elements inside the test card:
    - Text description: "Create a test Draft Order in Shopify to verify your pricing matrix works correctly. This creates a real draft order visible in your Shopify admin."
    - Product selector: Dropdown/Select of products assigned to this matrix (from `loaderData.products`). If no products assigned, show message "Assign at least one product to test Draft Order creation."
    - Width input: TextField (number) with label "Width ({unit})" where unit comes from loaderData.unit
    - Height input: TextField (number) with label "Height ({unit})" where unit comes from loaderData.unit
    - Quantity input: TextField (number) with label "Quantity", default value "1"
    - "Create Test Draft Order" Button (variant="primary")
    - Result area: Show success banner with Draft Order name and link info, or error banner

    **Action handler for test Draft Order:**

    Add a new intent `create-test-draft-order` to the existing action function in `app.matrices.$id.edit.tsx`:

    - Extract productId, width, height, quantity from form data
    - Convert dimensions to mm if store unitPreference is "cm" (multiply by 10)
    - Get `admin` from `authenticate.admin(request)` (already available at top of action)
    - Find the product assignment to get productTitle
    - Call `createDraftOrder()` from draft-order.server.ts
    - Return result as JSON

    **Client-side state for test flow:**
    - `testProductId` (string): selected product from dropdown
    - `testWidth` (string): width input value
    - `testHeight` (string): height input value
    - `testQuantity` (string): quantity input value, default "1"
    - `testResult` (success/error state from action response)
    - Use a separate `useFetcher` for the test flow (don't share with save/product fetcher)

    **Loader changes:**
    - No changes needed — products and unit are already loaded

    **IMPORTANT navigation pattern:** Use `useFetcher` for the test draft order submission (not `useSubmit`) to avoid page navigation. This matches the existing pattern in the file.

    **Dashboard Counter:**

    In `app/routes/app._index.tsx`:
    - Update the loader to also fetch `store.totalDraftOrdersCreated`
    - Add a new Card section (between API Key card and Matrices card) showing "Draft Orders Created: {count}"
    - Only show this card if count > 0 (don't show empty state on fresh install)
    - Simple display: Text heading "Draft Orders" + count value, with a note "Orders created with matrix pricing. View in Shopify admin using the 'price-matrix' tag filter."
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Test the flow manually:
    1. Navigate to matrix edit page
    2. See test Draft Order card at bottom (if products assigned)
    3. Enter dimensions and quantity
    4. Click Create Test Draft Order
    5. See success/error result
    6. Check Shopify admin for draft order with `price-matrix` tag
    7. Dashboard shows updated count
  </verify>
  <done>Matrix edit page has test Draft Order card with product selector, dimension inputs, and create button. Dashboard shows Draft Orders created count when > 0. Creating a test draft order calls Shopify GraphQL API and saves local record.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Draft Order creation flow: price calculator, database schema, Shopify GraphQL integration, test UI on matrix edit page, and dashboard counter.</what-built>
  <how-to-verify>
    1. Start the dev server with `shopify app dev`
    2. Navigate to an existing matrix that has products assigned
    3. Scroll to the bottom of the matrix edit page to find the "Test Draft Order" card
    4. Select a product from the dropdown
    5. Enter sample dimensions (e.g., width: 500, height: 300 in mm)
    6. Set quantity to 1
    7. Click "Create Test Draft Order"
    8. Verify success message appears with Draft Order name (e.g., "#D1")
    9. Go to Shopify admin -> Orders -> Drafts
    10. Find the new draft order — verify it has:
        - The correct product
        - Custom price (from matrix, not product default)
        - Custom attributes showing Width and Height with dimensions
        - Tag "price-matrix"
    11. Navigate back to the app dashboard
    12. Verify "Draft Orders Created" count shows >= 1
    13. (Optional) Complete the draft order in Shopify admin and verify the custom price is locked through to the real order
  </how-to-verify>
  <resume-signal>Type "approved" if Draft Order appears correctly in Shopify admin with custom pricing, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (TypeScript compiles)
- Test Draft Order creates a real Shopify Draft Order with custom matrix price
- Draft Order in Shopify admin has correct product, price, custom attributes, and tag
- Local DraftOrderRecord saved in database
- Dashboard counter incremented
- Error cases handled: no products assigned, invalid dimensions, Shopify API errors
</verification>

<success_criteria>
- Merchant can create a test Draft Order from the matrix edit page
- Draft Order price matches the matrix-calculated price (not product default)
- Draft Order has "price-matrix" tag and dimension custom attributes
- Local record saved and dashboard counter updated
- Shopify API retry logic handles rate limits with exponential backoff
- Products without matrix assignment show clear error
</success_criteria>

<output>
After completion, create `.planning/phases/03-draft-orders-integration/03-03-SUMMARY.md`
</output>
