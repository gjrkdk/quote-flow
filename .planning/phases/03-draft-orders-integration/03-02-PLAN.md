---
phase: 03-draft-orders-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/*
autonomous: true

must_haves:
  truths:
    - "DraftOrderRecord table exists in database with all required columns"
    - "Store model has totalDraftOrdersCreated counter field"
    - "DraftOrderRecord has cascade delete relations to Store and PriceMatrix"
    - "Database migration applies cleanly"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "DraftOrderRecord model, Store counter field, PriceMatrix relation"
      contains: "model DraftOrderRecord"
    - path: "prisma/migrations/*/migration.sql"
      provides: "Database migration for new model and field"
  key_links:
    - from: "prisma/schema.prisma DraftOrderRecord"
      to: "prisma/schema.prisma Store"
      via: "storeId foreign key with onDelete Cascade"
      pattern: "storeId.*Store.*onDelete.*Cascade"
    - from: "prisma/schema.prisma DraftOrderRecord"
      to: "prisma/schema.prisma PriceMatrix"
      via: "matrixId foreign key with onDelete Cascade"
      pattern: "matrixId.*PriceMatrix.*onDelete.*Cascade"
---

<objective>
Add the DraftOrderRecord database model for tracking created Draft Orders and add a totalDraftOrdersCreated counter to the Store model. Run the Prisma migration against PostgreSQL.

Purpose: Local order history tracking enables the dashboard counter and provides audit trail. The counter field enables efficient dashboard display without counting records.

Output: Updated Prisma schema with DraftOrderRecord model and applied migration.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-draft-orders-integration/03-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DraftOrderRecord model and Store counter to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add the DraftOrderRecord model to `prisma/schema.prisma` with these fields:
    - `id` String @id @default(cuid())
    - `storeId` String (FK to Store)
    - `matrixId` String (FK to PriceMatrix)
    - `shopifyDraftOrderId` String — stores the Shopify GID (e.g., "gid://shopify/DraftOrder/123")
    - `shopifyOrderName` String — stores the human-readable name (e.g., "#D1")
    - `productId` String — product GID
    - `variantId` String — variant GID (required for Draft Order creation)
    - `width` Float — width dimension in mm (internal unit)
    - `height` Float — height dimension in mm (internal unit)
    - `quantity` Int
    - `calculatedPrice` Float — unit price from matrix lookup
    - `totalPrice` String — total price string from Shopify response
    - `createdAt` DateTime @default(now())

    Relations:
    - `store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)`
    - `matrix PriceMatrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)`

    Indexes:
    - `@@index([storeId])`
    - `@@index([matrixId])`
    - `@@index([shopifyDraftOrderId])`

    Also add to the existing Store model:
    - `totalDraftOrdersCreated Int @default(0)`
    - `draftOrderRecords DraftOrderRecord[]`

    Also add to the existing PriceMatrix model:
    - `draftOrderRecords DraftOrderRecord[]`

    Follow existing schema conventions (cuid IDs, cascade deletes, index patterns).
  </action>
  <verify>
    Run `npx prisma validate` to verify schema is valid.
    Run `npx prisma format` to ensure formatting is consistent.
  </verify>
  <done>Prisma schema contains DraftOrderRecord model with all fields, relations, and indexes. Store has totalDraftOrdersCreated counter and draftOrderRecords relation. PriceMatrix has draftOrderRecords relation.</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply database migration</name>
  <files>prisma/migrations/*</files>
  <action>
    Generate and apply the Prisma migration for the schema changes.

    Run: `npx prisma migrate dev --name add_draft_order_records`

    This creates the migration SQL and applies it to the PostgreSQL database on localhost:5400.

    After migration, run `npx prisma generate` to update the Prisma client types.

    If the database is not running, start it first with Docker: check if container is running, start if needed. The database connection is `postgresql://postgres:postgres@localhost:5400/shopify_price_app`.

    Verify the migration applied by checking that:
    1. Migration file was created in `prisma/migrations/` directory
    2. `npx prisma migrate status` shows no pending migrations
  </action>
  <verify>
    `npx prisma migrate status` shows all migrations applied.
    `npx prisma generate` completes without errors.
    Migration SQL file exists in prisma/migrations/ with the new table creation.
  </verify>
  <done>Database has DraftOrderRecord table and Store has totalDraftOrdersCreated column. Prisma client is regenerated with new types.</done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes
- `npx prisma migrate status` shows no pending migrations
- `npx prisma generate` succeeds
- DraftOrderRecord model accessible via `prisma.draftOrderRecord`
</verification>

<success_criteria>
- DraftOrderRecord table exists in PostgreSQL with all required columns and indexes
- Store table has totalDraftOrdersCreated column with default 0
- Foreign key cascade deletes configured for both Store and PriceMatrix relations
- Prisma client types include DraftOrderRecord for use in Phase 3 Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/03-draft-orders-integration/03-02-SUMMARY.md`
</output>
