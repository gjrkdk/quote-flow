---
phase: 02-admin-matrix-management
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - app/routes/app.matrices.$id.edit.tsx
  - app/components/ProductPicker.tsx
autonomous: true

must_haves:
  truths:
    - "Merchant can open Shopify Resource Picker to select products from their store"
    - "Selected products appear in a list below the price grid"
    - "Merchant can remove a product assignment from the list"
    - "When assigning a product already linked to another matrix, merchant sees a warning and must confirm"
    - "Product assignments persist after saving"
    - "Product count reflects in the matrix list page"
  artifacts:
    - path: "app/components/ProductPicker.tsx"
      provides: "Shopify Resource Picker wrapper with assignment warning"
      min_lines: 30
    - path: "app/routes/app.matrices.$id.edit.tsx"
      provides: "Updated editor with product assignment section"
      contains: "ProductPicker"
  key_links:
    - from: "app/components/ProductPicker.tsx"
      to: "shopify.resourcePicker"
      via: "App Bridge Resource Picker API call"
      pattern: "resourcePicker"
    - from: "app/routes/app.matrices.$id.edit.tsx"
      to: "prisma.productMatrix"
      via: "action creating/deleting product assignments"
      pattern: "prisma\\.productMatrix"
---

<objective>
Add product assignment functionality to the matrix editor. Merchants can assign products to a matrix using Shopify's Resource Picker and see which products are currently linked.

Purpose: This completes the matrix management flow — merchants need to link matrices to products so the pricing applies in their storefronts (MATRIX-05, MATRIX-06).
Output: Working product picker with assignment, reassignment warnings, and product list in the editor.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-matrix-management/02-RESEARCH.md
@.planning/phases/02-admin-matrix-management/02-03-SUMMARY.md
@app/routes/app.matrices.$id.edit.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ProductPicker component with Resource Picker integration</name>
  <files>app/components/ProductPicker.tsx</files>
  <action>
Create `app/components/ProductPicker.tsx`:

This component provides the product assignment UI for the matrix editor. It includes:

1. **"Add products" button** — triggers Shopify Resource Picker
2. **Product list** — shows currently assigned products with remove buttons
3. **Reassignment warning modal** — shown when selected product already has a different matrix

Props interface:
```typescript
interface ProductPickerProps {
  assignedProducts: Array<{
    id: string;          // ProductMatrix record id
    productId: string;   // Shopify product GID
    productTitle: string;
  }>;
  onAssign: (products: Array<{ id: string; title: string }>) => void;
  onRemove: (productMatrixId: string) => void;
  conflictProducts?: Array<{
    productId: string;
    productTitle: string;
    currentMatrixName: string;
  }>;
  onConfirmReassign?: (productIds: string[]) => void;
  onCancelReassign?: () => void;
}
```

Implementation:

**Resource Picker trigger:**
- Use `useAppBridge()` from `@shopify/app-bridge-react` to get the `shopify` object
- On "Add products" click: `const selected = await shopify.resourcePicker({ type: "product", multiple: true, filter: { hidden: false, variants: false } })`
- If selected, call `onAssign` with array of `{ id: product.id, title: product.title }`
- The parent (editor route) handles checking for conflicts before persisting

**Product list:**
- Render with Polaris `ResourceList` and `ResourceItem`:
  - Each item shows product title
  - Each item has a "Remove" action that calls `onRemove(productMatrixId)`
- When list is empty: show subtle text "No products assigned yet"

**Reassignment warning modal (Polaris Modal):**
- Open when `conflictProducts` is non-empty
- Title: "Products already assigned"
- Body: list each conflict product with "'{productTitle}' is currently assigned to '{currentMatrixName}'"
- Primary action (destructive): "Reassign" — calls `onConfirmReassign`
- Secondary: "Cancel" — calls `onCancelReassign`

Wrap in Polaris `Card` with title "Products" and subtitle "Assign products that should use this pricing matrix."
  </action>
  <verify>
- Component file exists and exports ProductPicker
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>ProductPicker component renders product list with add/remove functionality and reassignment conflict modal.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate product assignment into the matrix editor route</name>
  <files>app/routes/app.matrices.$id.edit.tsx</files>
  <action>
Update `app/routes/app.matrices.$id.edit.tsx` to include product assignment:

**Loader updates:**
- Already fetching `products` from the matrix relation (from Plan 03)
- Serialize products: `{ id, productId, productTitle }`

**Action: add new intents:**

1. **`intent: "assign-products"`**
   - Parse JSON from `formData.get("products")`: `Array<{ id: string, title: string }>`
   - For each product, check if it's already assigned to a DIFFERENT matrix:
     ```typescript
     const existing = await prisma.productMatrix.findUnique({
       where: { productId: product.id },
       include: { matrix: { select: { id: true, name: true } } },
     });
     ```
   - If conflicts exist and `formData.get("confirmed") !== "true"`:
     - Return `json({ success: false, conflicts: [...conflictData] })`
   - If confirmed or no conflicts:
     - In a transaction, for each product:
       - Delete existing assignment if any: `prisma.productMatrix.deleteMany({ where: { productId: product.id } })`
       - Create new assignment: `prisma.productMatrix.create({ data: { matrixId, productId: product.id, productTitle: product.title } })`
     - Return `json({ success: true })`

2. **`intent: "remove-product"`**
   - Parse `productMatrixId` from formData
   - Verify the ProductMatrix belongs to this matrix (security check)
   - Delete: `prisma.productMatrix.delete({ where: { id: productMatrixId } })`
   - Return `json({ success: true })`

**UI updates:**

Replace the "Products coming soon" placeholder Card with the `<ProductPicker>` component:

```tsx
<ProductPicker
  assignedProducts={products}
  onAssign={handleAssignProducts}
  onRemove={handleRemoveProduct}
  conflictProducts={conflictProducts}
  onConfirmReassign={handleConfirmReassign}
  onCancelReassign={() => setConflictProducts([])}
/>
```

State additions:
- `conflictProducts: ConflictProduct[]` — populated from action response
- `pendingProducts: Product[]` — products waiting for conflict resolution

Handler implementations:
- `handleAssignProducts(products)`: Submit via fetcher with `intent: "assign-products"`. If response has conflicts, store them in state and show modal. If success, clear pending and refresh.
- `handleRemoveProduct(id)`: Submit via fetcher with `intent: "remove-product"`.
- `handleConfirmReassign()`: Re-submit with `confirmed: "true"` flag.

After successful assignment or removal, the loader data refreshes (Remix revalidation) to show updated product list.

Important: Product assignment is independent of the matrix save button. Products are assigned/removed immediately (not part of the "unsaved changes" workflow). This matches the UX expectation — product assignment is a discrete action, not a draft state.
  </action>
  <verify>
1. Open matrix editor for a matrix
2. Click "Add products" — Shopify Resource Picker opens
3. Select a product — it appears in the assigned products list
4. Click remove on a product — it disappears
5. Assign a product that's already linked to another matrix — warning modal appears
6. Confirm reassignment — product moves to this matrix
7. Go to matrix list — product count column reflects changes
  </verify>
  <done>Product assignment fully functional in matrix editor. Resource Picker opens for selection, products listed with remove action, reassignment conflicts show confirmation modal. Assignments persist in database with one-matrix-per-product constraint.</done>
</task>

</tasks>

<verification>
1. Resource Picker opens and returns selected products
2. Products appear in the assignment list after selection
3. Remove button works and updates the list
4. Reassignment conflict flow works (warning + confirm)
5. Product counts visible in matrix list page
6. Database constraint ensures one matrix per product
</verification>

<success_criteria>
- Products can be assigned to a matrix via Shopify Resource Picker
- Assigned products display in a list with remove capability
- Reassigning a product from another matrix shows a warning with the current matrix name
- Product assignments persist in the database
- Matrix list page shows correct product counts
- One-matrix-per-product constraint enforced (MATRIX-06)
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-matrix-management/02-04-SUMMARY.md`
</output>
