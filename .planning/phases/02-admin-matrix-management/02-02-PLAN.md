---
phase: 02-admin-matrix-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/routes/app.tsx
  - app/routes/app.matrices._index.tsx
  - app/routes/app.matrices.new.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar navigation shows 'Matrices' link alongside Dashboard and Settings"
    - "Matrices page shows EmptyState when no matrices exist with 'Create matrix' CTA"
    - "Matrices page shows IndexTable with matrix name, grid size, product count, last edited when matrices exist"
    - "Merchant can create a new matrix by choosing a name and starter template"
    - "After creating a matrix, merchant is redirected to the matrix editor"
  artifacts:
    - path: "app/routes/app.matrices._index.tsx"
      provides: "Matrix list page with EmptyState and IndexTable"
      min_lines: 60
    - path: "app/routes/app.matrices.new.tsx"
      provides: "Create matrix page with name and template selection"
      min_lines: 40
    - path: "app/routes/app.tsx"
      provides: "Updated nav with Matrices link"
      contains: "matrices"
  key_links:
    - from: "app/routes/app.matrices._index.tsx"
      to: "prisma.priceMatrix"
      via: "loader query with breakpoint and product counts"
      pattern: "prisma\\.priceMatrix\\.findMany"
    - from: "app/routes/app.matrices.new.tsx"
      to: "prisma.priceMatrix.create"
      via: "Remix action creating matrix with template breakpoints"
      pattern: "prisma\\.priceMatrix\\.create"
---

<objective>
Build the matrix list page and create matrix page, and add the "Matrices" nav link to the sidebar.

Purpose: Merchants need to see their matrices and create new ones. This is the entry point to the matrix management flow.
Output: Working matrix list with EmptyState/IndexTable, create matrix page with template selection, sidebar nav link.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-matrix-management/02-01-SUMMARY.md
@app/routes/app.tsx
@prisma/schema.prisma
@app/db.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Matrices nav link and build matrix list page</name>
  <files>app/routes/app.tsx, app/routes/app.matrices._index.tsx</files>
  <action>
**1. Update sidebar navigation in `app/routes/app.tsx`:**
Add a "Matrices" link between Dashboard and Settings in the `<ui-nav-menu>`:
```tsx
<Link to="/app/matrices">Matrices</Link>
```

**2. Create `app/routes/app.matrices._index.tsx`:**

**Loader:**
- Authenticate via `authenticate.admin(request)`
- Query matrices for the current store:
  ```typescript
  const store = await prisma.store.findUnique({ where: { shop: session.shop } });
  const matrices = await prisma.priceMatrix.findMany({
    where: { storeId: store.id },
    include: {
      widthBreakpoints: { where: { axis: "width" } },
      heightBreakpoints: { where: { axis: "height" } },  // Use separate query alias
      _count: { select: { products: true } },
    },
    orderBy: { updatedAt: "desc" },
  });
  ```
  Note: Prisma doesn't support relation aliases in include. Instead, include all breakpoints and filter in the serialization step:
  ```typescript
  const matrices = await prisma.priceMatrix.findMany({
    where: { storeId: store.id },
    include: {
      breakpoints: true,
      _count: { select: { products: true } },
    },
    orderBy: { updatedAt: "desc" },
  });
  ```
  Then in serialization, count width/height breakpoints by filtering `breakpoints` array by `axis`.

- Return serialized data: `{ id, name, widthCount, heightCount, productCount, updatedAt }`

**Action:**
- Handle `intent: "delete"` with `matrixId` form field:
  - `await prisma.priceMatrix.delete({ where: { id: matrixId } })` — cascade handles cleanup
  - Return `json({ success: true })`
- Handle `intent: "duplicate"` with `matrixId` form field:
  - Load full matrix with breakpoints and cells
  - Create new matrix with name `"[Original Name] (copy)"`
  - Copy all breakpoints and cells using `prisma.$transaction`
  - Redirect to the new matrix's edit page

**UI:**

When `matrices.length === 0`, show Polaris `EmptyState`:
- heading: "Create your first pricing matrix"
- action: `{ content: "Create matrix", url: "/app/matrices/new" }`
- image: Use Polaris empty state image URL
- Body text: "Set up dimension-based pricing by creating a matrix with width and height breakpoints. Assign it to products to offer custom pricing based on customer dimensions."

When matrices exist, show:
- `Page` with title "Matrices" and `primaryAction={{ content: "Create matrix", url: "/app/matrices/new" }}`
- `Card` with `padding="0"` wrapping `IndexTable`
- `IndexTable` with `selectable={false}` and headings: Name, Grid size, Products, Last edited
- Each row: clickable (navigate to `/app/matrices/${id}/edit`), shows:
  - Name as bold text
  - Grid size as "{widthCount} x {heightCount}"
  - Product count as "{n} products"
  - Last edited as relative date (use `new Date(updatedAt).toLocaleDateString()`)

For each row, add a Polaris `ActionList` or inline actions for Delete and Duplicate:
- Delete: show Polaris `Modal` confirmation with "This will permanently delete this matrix and unassign {n} products." Red destructive primary action.
- Duplicate: submit fetcher form with `intent: "duplicate"`, show loading state.

Use `useNavigate` from `@remix-run/react` for row click navigation.
  </action>
  <verify>
Start dev server. Navigate to `/app/matrices`.
- With no matrices: EmptyState shows with "Create matrix" button
- Sidebar shows "Matrices" link between Dashboard and Settings
- "Create matrix" button links to `/app/matrices/new`
  </verify>
  <done>Matrices page shows EmptyState when empty, IndexTable when matrices exist. Navigation link appears in sidebar. Delete and duplicate actions functional.</done>
</task>

<task type="auto">
  <name>Task 2: Build create matrix page with name and template selection</name>
  <files>app/routes/app.matrices.new.tsx</files>
  <action>
Create `app/routes/app.matrices.new.tsx`:

**Loader:**
- Authenticate via `authenticate.admin(request)`
- Fetch store to get `unitPreference` (needed for template display)
- Return `{ unitPreference }`

**Action:**
- Parse form: `name` (string), `template` (string: "small" | "medium" | "custom")
- Validate: name is required, max 100 chars
- Create the matrix in a `prisma.$transaction`:

Template definitions (breakpoint values in the store's unit):
- **Small (3x3):** widths: [300, 600, 900], heights: [300, 600, 900] (mm) or [30, 60, 90] (cm)
- **Medium (5x5):** widths: [200, 400, 600, 800, 1000], heights: [200, 400, 600, 800, 1000] (mm) or [20, 40, 60, 80, 100] (cm)
- **Custom:** no breakpoints (merchant adds them in editor)

Transaction steps:
1. Find store by `session.shop`
2. Create `PriceMatrix` with name and storeId
3. If template is not "custom", create `Breakpoint` records for width and height axes with position indices (0, 1, 2...)
4. If template is not "custom", create `MatrixCell` records with `price: 0` for every width x height combination (using position indices)

After creation, redirect to `/app/matrices/${newMatrix.id}/edit`

**UI (Polaris):**
- `Page` with title "Create matrix" and `backAction={{ url: "/app/matrices" }}`
- `Layout` > `Layout.Section` > `Card`:
  - `TextField` for matrix name (required, max 100 chars)
  - `ChoiceList` (or `RadioButton` group) for template:
    - Small (3x3): "3 x 3 grid — good for simple pricing"
    - Medium (5x5): "5 x 5 grid — more granular pricing"
    - Custom: "Empty grid — add your own breakpoints"
  - Show preview text: "Breakpoints: {values} {unit}" for the selected template
- `PageActions` with primary action "Create" (submit form) and secondary "Cancel" (navigate back)
- Show validation errors inline via `Banner` if name is missing

Use `Form` from `@remix-run/react` with `method="post"`.
  </action>
  <verify>
Navigate to `/app/matrices/new`.
- Page shows name field and template selector
- Selecting "Small" shows 3x3 preview
- Submitting with a name creates the matrix and redirects to the editor page
- Submitting without a name shows validation error
  </verify>
  <done>Create matrix page renders with name input and 3 template options. Submitting creates the matrix with breakpoints and cells in the database and redirects to the editor URL.</done>
</task>

</tasks>

<verification>
1. Sidebar navigation shows Dashboard, Matrices, Settings
2. `/app/matrices` shows EmptyState when no matrices exist
3. Creating a matrix via `/app/matrices/new` populates the database
4. After creation, URL redirects to `/app/matrices/{id}/edit`
5. Going back to `/app/matrices` shows the new matrix in the IndexTable
</verification>

<success_criteria>
- "Matrices" nav link visible and functional
- EmptyState renders when no matrices, IndexTable renders when matrices exist
- Matrix creation with templates works (3x3, 5x5, empty)
- Delete and duplicate actions work from the list page
- Created matrices have correct breakpoints and zero-value cells in database
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-matrix-management/02-02-SUMMARY.md`
</output>
